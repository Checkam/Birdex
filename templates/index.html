<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birdex</title>
    <link rel="icon" type="image/png" href="/static/logo.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Meta tags pour PWA -->
    <meta name="theme-color" content="#ef4444">
    <meta name="description" content="Suivez vos découvertes d'oiseaux comme un Pokédex ornithologique">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Birdex">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel standalone for in-browser JSX transpilation (development only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS et JS pour la carte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Scripts pour le mode hors-ligne -->
    <script src="/static/db.js"></script>
    <script src="/static/sync-manager.js"></script>
</head>
<body>
    <div id="root"></div>
    <!-- Load the app with Babel to transpile JSX in-browser (dev). For production, bundle instead. -->
    <script type="text/babel" src="/static/app.js?v=2.2" data-presets="react"></script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('✓ Service Worker enregistré:', registration.scope);

                        // Vérifier les mises à jour du SW
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('Nouvelle version du Service Worker détectée');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nouvelle version disponible
                                    console.log('Nouvelle version disponible. Rafraîchir pour mettre à jour.');

                                    // Optionnel: Afficher une notification à l'utilisateur
                                    if (confirm('Une nouvelle version de Birdex est disponible. Rafraîchir maintenant ?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('✗ Erreur lors de l\'enregistrement du Service Worker:', err);
                    });

                // Recharger la page quand le SW est mis à jour
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            });
        }

        // Gestion de l'installation PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('✓ PWA installable détectée');

            // Optionnel: Vous pouvez afficher un bouton d'installation personnalisé ici
            // Par exemple, stocker l'événement pour l'utiliser plus tard avec un bouton
        });

        window.addEventListener('appinstalled', () => {
            console.log('✓ PWA installée avec succès!');
            deferredPrompt = null;
        });

        // Écouter les messages du Service Worker
        navigator.serviceWorker.addEventListener('message', (event) => {
            console.log('[App] Message du Service Worker:', event.data);

            if (event.data.type === 'sync-success') {
                console.log(`✓ ${event.data.count} élément(s) synchronisé(s)`);
                // L'app React peut écouter ces événements via window events
                window.dispatchEvent(new CustomEvent('sync-success', { detail: event.data }));
            }

            if (event.data.type === 'sync-error') {
                console.error('✗ Erreur de synchronisation:', event.data.error);
                window.dispatchEvent(new CustomEvent('sync-error', { detail: event.data }));
            }
        });
    </script>
</body>
</html>